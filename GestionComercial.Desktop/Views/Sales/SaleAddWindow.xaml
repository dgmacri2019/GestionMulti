<Window x:Class="GestionComercial.Desktop.Views.Sales.SaleAddWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" 
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" 
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
        xmlns:local="clr-namespace:GestionComercial.Desktop.Views.Searchs"
        MinHeight="700"
        MinWidth="900"
        Width="900"
        Height="700"
        Loaded="miUserControl_Loaded" 
        KeyDown="Window_KeyDown"
        Background="LightGray"
        WindowStartupLocation="CenterScreen"
        SizeChanged="miUserControl_SizeChanged"
        Title="Nueva Venta">
    <Window.Resources>
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        
    </Window.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="70"/>
            <!-- Sidebar -->
            <ColumnDefinition Width="*"/>
            <!-- Contenido -->
        </Grid.ColumnDefinitions>

        <!-- Sidebar -->
        <Border Grid.Column="0" Background="LightBlue">
            <StackPanel VerticalAlignment="Stretch" HorizontalAlignment="Center" Margin="0,20">
                <!-- Salir -->
                <Button x:Name="btnSalir" Width="40" Height="40" Margin="0,10"
                        ToolTip="Salir (ESC)"
                        Click="BtnCancel_Click">
                    <Image Source="/Images/Exit 24.png" Width="24" Height="24"/>
                </Button>

                <!-- Buscar -->
                <Button x:Name="btnBuscar" Width="40" Height="40" Margin="0,10"
                        ToolTip="Buscar"
                        Click="BtnBuscar_Click">
                    <Image Source="/Images/search 24.png" Width="24" Height="24"/>
                </Button>

                <!-- Guardar -->
                <Button x:Name="btnGuardar" Width="40" Height="40" Margin="0,10"
                        ToolTip="Guardar (F2)"
                        Click="BtnAdd_Click">
                    <Image Source="/Images/Save File 24.png" Width="24" Height="24"/>
                </Button>

                <!-- Imprimir -->
                <Button x:Name="btnImprimir" Width="40" Height="40" Margin="0,10"
                        ToolTip="Imprimir"
                        Click="BtnImprimir_Click">
                    <Image Source="/Images/Print 24.png" Width="24" Height="24"/>
                </Button>

                <!-- Cancelar --><!--
                <Button x:Name="btnCancelar" Width="40" Height="40" Margin="0,10"
                        ToolTip="Cancelar (ESC)"
                        Click="BtnCancel_Click">
                    <Image Source="/Images/Exit 24.png" Width="24" Height="24"/>
                </Button>-->
            </StackPanel>
        </Border>

        <!-- Contenido principal -->

        <Grid x:Name="GridGeneral" Grid.Column="1" Margin="10" Background="LightGray">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <!-- DataGrid -->
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Fecha -->
            <Grid Grid.Row="0" Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Fecha" 
                       VerticalAlignment="Center" 
                           Grid.Column="0"
                       Style="{StaticResource BlueBold10}"/>
            <DatePicker x:Name="dpDate" 
                        Grid.Column="1" 
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Width="200" />
            </Grid>


            <!-- Venta Nº -->
            <Grid Grid.Row="1" Margin="0,0,0,5" Height="18">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="Venta Nº" 
                       VerticalAlignment="Center" 
                           Grid.Column="0"
                       Style="{StaticResource BlueBold10}"/>
                <TextBox x:Name="txtSaleNumber" 
                     Style="{StaticResource TextBoxSearch}" 
                         Grid.Column="1"
                         MinWidth="80"
                     IsReadOnly="True"
                         HorizontalAlignment="Left"
                     Text="{Binding SaleNumberString, Mode=OneWay}"/>
            </Grid>
            <!-- Cliente y detalles -->
            <Grid Grid.Row="2" Margin="0,0,0,5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Cliente -->
                <TextBlock Text="Cliente" Grid.Row="0" Grid.Column="0"
                           VerticalAlignment="Center" Style="{StaticResource BlueBold10}"/>
                <TextBox x:Name="txtClientCode" Grid.Row="0" Grid.Column="1"
                         Style="{StaticResource TextBoxSearch}"
                         MinWidth="80"
                         HorizontalAlignment="Left"
                         KeyDown="txtClientCode_KeyDown"/>

                <!-- Nombre -->
                <TextBox x:Name="txtFansatyName" Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                         Style="{StaticResource TextBoxSearch}" 
                         IsReadOnly="True"
                         HorizontalAlignment="Stretch"
                         Text="{Binding FantasyName}"/>

                <!-- Dirección -->
                <TextBox x:Name="txtAddress" Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                         Style="{StaticResource TextBoxSearch}"
                         Height="60"
                         TextWrapping="Wrap"
                         IsReadOnly="True"
                         HorizontalAlignment="Stretch"
                         Text="{Binding Address}"/>

                <!-- Email + checkbox -->
                <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="txtEmail" Grid.Column="0"
                             Style="{StaticResource TextBoxSearch}"
                             HorizontalAlignment="Stretch"
                             Text="{Binding Email}"/>
                    <CheckBox x:Name="chSendEmail" Grid.Column="1"
                              Style="{StaticResource CheckBox}"
                              VerticalAlignment="Center" Margin="5,0"/>
                    <TextBlock Text="Enviar Comprobante por mail" Grid.Column="2"
                               VerticalAlignment="Center"
                               Style="{StaticResource BlackNormal10}" Margin="5,0"/>
                </Grid>
            </Grid>
            <!-- Lista de precios y Condición de venta -->
            <Grid Grid.Row="3" Margin="0,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Grid.Column="0">
                    <TextBlock Text="Lista de Precios" Style="{StaticResource BlueBold10}"
                               VerticalAlignment="Center"/>
                    <ComboBox x:Name="cbPriceLists" 
                              Style="{StaticResource ComboBox}" 
                              Margin="5,0"
                              HorizontalAlignment="Stretch"
                              ItemsSource="{Binding PriceLists}"
                              DisplayMemberPath="Description"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding PriceListId}"
                              IsEnabled="False"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Grid.Column="1" HorizontalAlignment="Right">
                    <TextBlock Text="Condición de Venta" Style="{StaticResource BlueBold10}"
                               VerticalAlignment="Center"/>
                    <ComboBox x:Name="cbSaleConditions" 
                              Style="{StaticResource ComboBox}" 
                              Margin="5,0"
                              HorizontalAlignment="Stretch"
                              ItemsSource="{Binding SaleConditions}"
                              DisplayMemberPath="Description"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding SaleConditionId}"/>
                </StackPanel>
            </Grid>
            <!-- DataGrid artículos -->        
            <DataGrid x:Name="dgArticles" 
                          Grid.Row="4"
                          ItemsSource="{Binding ArticleItems, RelativeSource={RelativeSource AncestorType=Window}}" 
                          AutoGenerateColumns="False" 
                          CanUserAddRows="False" 
                      CanUserSortColumns="False"
                          HeadersVisibility="Column" 
                          Margin="5"
                      Visibility="Hidden"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          KeyDown="dgArticles_KeyDown" 
                          CellEditEnding="dgArticles_CellEditEnding"
                          PreparingCellForEdit="dgArticles_PreparingCellForEdit"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                      AlternationCount="1000000">
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <DataTrigger Value="True">
                                <DataTrigger.Binding>
                                    <MultiBinding Converter="{StaticResource LastRowByIndexConverter}">
                                        <!-- Index de la fila -->
                                        <Binding Path="(ItemsControl.AlternationIndex)" RelativeSource="{RelativeSource Self}"/>
                                        <!-- Cantidad de items -->
                                        <Binding Path="Items.Count" RelativeSource="{RelativeSource AncestorType=DataGrid}"/>
                                    </MultiBinding>
                                </DataTrigger.Binding>
                                <Setter Property="Background" Value="LightGray"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
                <DataGrid.Columns>
                        <DataGridTextColumn Header="Código" 
                                            Binding="{Binding Code, UpdateSourceTrigger=PropertyChanged}" 
                                            Width="60">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Descripción" 
                                            Binding="{Binding Description}" 
                                            Width="200" 
                                            IsReadOnly="True"/>    
                        <DataGridTextColumn Binding="{Binding PriceListId, UpdateSourceTrigger=PropertyChanged}" 
                                            Width="60">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Lista de Precios"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           HorizontalAlignment="Center"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                            <DataGridTextColumn.EditingElementStyle>
                                <Style TargetType="TextBox">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.EditingElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Cantidad" 
                                            Binding="{Binding Quantity, UpdateSourceTrigger=LostFocus, Mode=TwoWay}"
                                            Width="60">
                            <DataGridTextColumn.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                                    <Setter Property="ToolTip">
                                        <Setter.Value>
                                            <ToolTip>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Description}" FontWeight="Bold"/>
                                                    <TextBlock Text="El producto esta por debajo del stock mínimo "/>
                                                </StackPanel>
                                            </ToolTip>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <!-- Fondo rojo si hay poco stock -->
                                        <DataTrigger Binding="{Binding IsLowStock}" Value="True">
                                            <Setter Property="Background" Value="LightCoral"/>
                                            <Setter Property="Foreground" Value="White"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                    
                                </Style>
                            </DataGridTextColumn.CellStyle>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>                                    
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                            <DataGridTextColumn.EditingElementStyle>
                                <Style TargetType="TextBox">
                                    <EventSetter Event="GotFocus" Handler="Quantity_GotFocus"/>
                                    <EventSetter Event="PreviewKeyDown" Handler="Quantity_PreviewKeyDown"/>
                                    <EventSetter Event="PreviewTextInput" Handler="Quantity_PreviewTextInput"/>
                                    <EventSetter Event="TextChanged" Handler="Quantity_TextChanged"/>
                                </Style>
                            </DataGridTextColumn.EditingElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Binding="{Binding SmallMeasureDescription, UpdateSourceTrigger=PropertyChanged}"
                                            Width="60">
                            <DataGridTextColumn.Header>
                                <TextBlock Text="Unidad de medida"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           HorizontalAlignment="Center"/>
                            </DataGridTextColumn.Header>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Precio" 
                                            Binding="{Binding Price, StringFormat={}{0:C2}}"
                                            Width="80" 
                                            IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Subtotal"
                                            Binding="{Binding Subtotal, StringFormat={}{0:C2}}"
                                            Width="100" 
                                            IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Bonif (%)" 
                                            Binding="{Binding Bonification, UpdateSourceTrigger=PropertyChanged}"
                                            Width="70">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="Total" 
                                            Binding="{Binding Total, StringFormat={}{0:C2}}" 
                                            Width="100"
                                            IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Setter Property="TextAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            <!-- Código de barras -->
            <Grid x:Name="dgPostMethod" 
                  Visibility="Hidden"
                  Grid.Row="5"
                  Margin="0,0,40,0"
                  HorizontalAlignment="Right">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="150"/>
                </Grid.ColumnDefinitions>
                <CheckBox x:Name="chBarcode" 
                          Content="Método POS" 
                          Grid.Column="0" 
                          Checked="chBarcode_Checked" 
                          Unchecked="chBarcode_Unchecked"/>
                <TextBox x:Name="txtBarcode"
                         Grid.Column="1"
                         MinWidth="250"
                         KeyDown="txtBarcode_KeyDown"/>
            </Grid>


            <!-- Barra inferior -->
            <StackPanel Grid.Row="6" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10">
                <TextBlock Text="Cantidad de items:" Style="{StaticResource BlueBold10}" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding TotalItems, RelativeSource={RelativeSource AncestorType=Window}}" 
                           Style="{StaticResource BlackNormal10}" Margin="5,0"/>
                <TextBlock Text="Precio total:" Style="{StaticResource BlueBold10}" Margin="20,0,0,0"
                           VerticalAlignment="Center"/>
                <TextBlock Text="{Binding TotalPrice, StringFormat={}{0:C2}, RelativeSource={RelativeSource AncestorType=Window}}" 
                           Style="{StaticResource BlackNormal10}" Margin="5,0"/>
            </StackPanel>

            <!-- Botones inferiores --><!--
            <StackPanel Grid.Row="7" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                <Button x:Name="btnCancel" Content="Cancelar" Click="BtnCancel_Click"
                        Style="{StaticResource BtnCancel}" Margin="5,0"/>
                <Button x:Name="btnUpdate" Content="Actualizar" Click="BtnUpdate_Click"
                        Style="{StaticResource BtnUpdate}" Margin="5,0"/>
                <Button x:Name="btnAdd" Content="Guardar" Click="BtnAdd_Click"
                        Style="{StaticResource BtnAdd}" Margin="5,0"/>
            </StackPanel>-->

            <!-- Label error -->
            <TextBlock x:Name="lblError" Grid.Row="8" Style="{StaticResource lblError20}"
                       TextWrapping="Wrap" HorizontalAlignment="Stretch"/>
        </Grid>
    </Grid>
</Window>